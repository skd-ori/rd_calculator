<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>イナズマイレブンVR RD計算機</title>
    <style>
      :root {
        --primary-color: #3b82f6;
        --at-color: #ef4444;
        --df-color: #3b82f6;
        --bg-color: #f3f4f6;
        --card-bg: #ffffff;
        --text-color: #1f2937;
      }
      body {
        font-family: "Helvetica Neue", Arial, sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        margin: 0;
        padding: 20px;
        display: flex;
        justify-content: center;
      }
      .container {
        width: 100%;
        max-width: 800px;
        background-color: var(--card-bg);
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        padding: 24px;
      }
      h1 {
        text-align: center;
        font-size: 1.5rem;
        margin-bottom: 24px;
        color: #111827;
      }
      .mode-selector {
        display: flex;
        gap: 12px;
        margin-bottom: 24px;
        flex-wrap: wrap;
        justify-content: center;
      }
      .btn {
        padding: 8px 16px;
        border-radius: 6px;
        border: 1px solid #d1d5db;
        background: white;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: bold;
      }
      .btn.active {
        background-color: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
      }
      .calc-area {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
        margin-bottom: 24px;
      }
      @media (max-width: 640px) {
        .calc-area {
          grid-template-columns: 1fr;
        }
      }
      .side-title {
        font-weight: bold;
        font-size: 1.1rem;
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 2px solid #e5e7eb;
      }
      .at-side .side-title {
        color: var(--at-color);
        border-color: var(--at-color);
      }
      .df-side .side-title {
        color: var(--df-color);
        border-color: var(--df-color);
      }

      .input-group {
        margin-bottom: 12px;
      }
      .input-group label {
        display: block;
        font-size: 0.9rem;
        margin-bottom: 4px;
        color: #4b5563;
      }
      .input-group input {
        width: 100%;
        padding: 8px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        box-sizing: border-box;
        font-size: 1rem;
      }
      .calculate-btn {
        width: 100%;
        padding: 12px;
        background-color: #10b981;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: bold;
        cursor: pointer;
        margin-bottom: 24px;
        transition: background-color 0.2s;
      }
      .calculate-btn:hover {
        background-color: #059669;
      }
      .result-area {
        background-color: #f9fafb;
        padding: 16px;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
      }
      .result-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 1rem;
      }
      .result-val {
        font-family: monospace;
        font-weight: bold;
      }
      .rd-display {
        font-size: 2rem;
        text-align: center;
        font-weight: bold;
        margin: 16px 0;
        color: #4f46e5;
      }
      .win-rate {
        text-align: center;
        font-size: 1.2rem;
        font-weight: bold;
      }
      .hidden {
        display: none;
      }
      .help-text {
        font-size: 0.8rem;
        color: #6b7280;
        margin-top: 4px;
      }
        /* Add styles for tech power buttons */
        .tech-btn-group {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }
        .tech-btn {
            padding: 4px 8px;
            font-size: 0.8rem;
            border: 1px solid #d1d5db;
            background: #f3f4f6;
            border-radius: 4px;
            cursor: pointer;
        }
        .tech-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .tech-label {
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 2px;
        }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>RD計算機 Ver1.0.3</h1>

      <div class="mode-selector">
        <button class="btn active" onclick="setMode('focus')">
          フォーカス AT/DF
        </button>
        <!-- Unused modes hidden
        <button class="btn" onclick="setMode('shoot')">
          シュート/キーパー
        </button>
        <button class="btn" onclick="setMode('scramble')">スクランブル</button>
        <button class="btn" onclick="setMode('direct')">実数値直接入力</button>
        -->
      </div>

      <div class="calc-area">
        <!-- Attack Side -->
        <div class="at-side">
          <div class="side-title">攻撃側 (AT)</div>

          <div id="inputs-at-stats">
            <!-- Dynamic inputs generated by JS -->
          </div>

          <div class="input-group" id="at-tech-power-input">
            <label>技威力</label>
            <div class="tech-label">ベース威力</div>
            <div class="tech-btn-group" id="at-base-btns">
                <!-- 30, 50, 60, 70, 85, 100 -->
            </div>
            <div class="tech-label">進化</div>
            <div class="tech-btn-group" id="at-evo-btns">
                <!-- 1~6 -->
            </div>
            <!-- Hidden inputs to store selection -->
            <input type="hidden" id="at-base-val" value="0">
            <input type="hidden" id="at-evo-val" value="1">
            <input type="number" id="at-tech-power" class="stat-input" value="0" readonly style="background-color: #f9fafb;">
          </div>

          <div class="input-group">
            <label>パッシブ補正 (%)</label>
            <input
              type="number"
              id="at-passive"
              value="0"
              placeholder="例: 20"
              oninput="calculateRD()"
            />
          </div>

          <div class="input-group hidden" id="at-direct-input">
            <label>最終実数値</label>
            <input type="number" id="at-real-value" placeholder="1500" />
          </div>

          <div class="help-text">計算結果(素点): <span id="at-calc-preview">0</span></div>
        </div>

        <!-- Defense Side -->
        <div class="df-side">
          <div class="side-title">防御側 (DF)</div>

          <div id="inputs-df-stats">
            <!-- Dynamic inputs generated by JS -->
          </div>

          <div class="input-group" id="df-tech-power-input">
            <label>技威力</label>
            <div class="tech-label">ベース威力</div>
            <div class="tech-btn-group" id="df-base-btns"></div>
            <div class="tech-label">進化</div>
            <div class="tech-btn-group" id="df-evo-btns"></div>
            
            <input type="hidden" id="df-base-val" value="0">
            <input type="hidden" id="df-evo-val" value="1">
            <input type="number" id="df-tech-power" class="stat-input" value="0" readonly style="background-color: #f9fafb;">
          </div>

          <div class="input-group">
            <label>パッシブ補正 (%)</label>
            <input
              type="number"
              id="df-passive"
              value="0"
              placeholder="例: 10"
              oninput="calculateRD()"
            />
          </div>

          <div class="input-group hidden" id="df-direct-input">
            <label>最終実数値</label>
            <input type="number" id="df-real-value" placeholder="1200" />
          </div>

          <div class="help-text">計算結果(素点): <span id="df-calc-preview">0</span></div>
        </div>
      </div>

      <button class="calculate-btn" onclick="calculateRD()">計算する</button>

      <div class="result-area" id="result-area" style="display: none">
        <div class="result-row">
          <span>攻撃側最終値</span>
          <span class="result-val" id="res-at-total">0</span>
        </div>
        <div class="result-row">
          <span>防御側最終値</span>
          <span class="result-val" id="res-df-total">0</span>
        </div>

        <div class="rd-display">RD <span id="res-rd">0.0</span>%</div>

        <div id="win-rate-container">
            <div class="win-rate" id="res-win-rate">AT勝率: 40%</div>
            <div style="text-align: center; margin-top: 8px; color: #6b7280;" id="res-judgment">--</div>
        </div>
      </div>
    </div>

    <script>
      // Tech Power Logic provided by user
    const TECH_DATA = {
        30: { 1:115, 2:115, 3:115, 4:115, 5:115, 6:115 }, 
        50: { 1:175, 2:192, 3:210, 4:227, 5:245, 6:262 },
        60: { 1:210, 2:231, 3:252, 4:273, 5:294, 6:315 },
        70: { 1:255, 2:280, 3:306, 4:331, 5:357, 6:382 },
        85: { 1:312, 2:343, 3:375, 4:405, 5:436, 6:468 }, // V3 updated to 375
        100: { 1:370, 2:407, 3:444, 4:481, 5:518, 6:555 }
    };
    
    // Evolution Labels
    const EVO_LABELS = {
        1: "無", 2: "V2/改", 3: "V3/真", 4: "V4/爆", 5: "A/絶", 6: "∞/神"
    };

    function initTechButtons(side) {
        const baseContainer = document.getElementById(`${side}-base-btns`);
        const evoContainer = document.getElementById(`${side}-evo-btns`);
        
        // Base Buttons (Added 0 for "No Tech")
        [0, 30, 50, 60, 70, 85, 100].forEach(base => {
            const btn = document.createElement('div');
            btn.className = 'tech-btn';
            btn.textContent = base === 0 ? "技なし" : base;
            btn.onclick = () => selectTechBase(side, base, btn);
            if (base === 0) btn.classList.add('active'); // Default to No Tech
            baseContainer.appendChild(btn);
        });

        // Evo Buttons
        [1, 2, 3, 4, 5, 6].forEach(evo => {
            const btn = document.createElement('div');
            btn.className = 'tech-btn';
            btn.textContent = EVO_LABELS[evo];
            btn.onclick = () => selectTechEvo(side, evo, btn);
            evoContainer.appendChild(btn);
        });

        // Set initial active state for default values
        const initialEvoBtn = evoContainer.children[0]; 
        if (initialEvoBtn) {
            initialEvoBtn.classList.add('active');
        }
        
        // Initial state update
        updateTechVisibility(side, 0);
    }

    function updateTechVisibility(side, base) {
        const evoContainer = document.getElementById(`${side}-evo-btns`);
        // If "No Tech" (0) is selected, maybe hide or dim evo buttons?
        // For now, let's just leave them as is but they won't add power since base is 0.
        // Actually, let's visually dim them if base is 0.
        if (base === 0) {
            evoContainer.style.opacity = '0.5';
            evoContainer.style.pointerEvents = 'none';
        } else {
            evoContainer.style.opacity = '1';
            evoContainer.style.pointerEvents = 'auto';
        }
    }

    function selectTechBase(side, base, btnEl) {
        document.getElementById(`${side}-base-val`).value = base;
        
        // Update UI
        const parent = document.getElementById(`${side}-base-btns`);
        Array.from(parent.children).forEach(c => c.classList.remove('active'));
        btnEl.classList.add('active');

        updateTechVisibility(side, base);
        updateTechPower(side);
    }

    function selectTechEvo(side, evo, btnEl) {
        document.getElementById(`${side}-evo-val`).value = evo;

        // Update UI
        const parent = document.getElementById(`${side}-evo-btns`);
        Array.from(parent.children).forEach(c => c.classList.remove('active'));
        btnEl.classList.add('active');

        updateTechPower(side);
    }

    function updateTechPower(side) {
        const base = parseInt(document.getElementById(`${side}-base-val`).value) || 0;
        const evo = parseInt(document.getElementById(`${side}-evo-val`).value) || 1;
        
        let power = 0;
        if (base > 0 && TECH_DATA[base]) {
            power = TECH_DATA[base][evo];
        }

        document.getElementById(`${side}-tech-power`).value = power;
        updatePreview(side); // Recalculate everything
    }

      // Form configurations
    const MODES = {
        focus: {
            name: "フォーカス",
            at: {
                label: "フォーカスAT",
                inputs: [
                    { id: "at-kick", label: "キック" },
                    { id: "at-ctrl", label: "コントロール" },
                    { id: "at-tech", label: "テクニック" }
                ],
                formula: (v) => (v['at-kick']/2) + v['at-tech'] + v['at-ctrl']
            },
            df: {
                label: "フォーカスDF",
                inputs: [
                    { id: "df-tech", label: "テクニック" },
                    { id: "df-intel", label: "インテリジェンス" },
                    { id: "df-agi", label: "アジリティ" }
                ],
                formula: (v) => v['df-tech'] + v['df-intel'] + (v['df-agi']/2)
            },
            showWinRate: false
        },
        shoot: {
            name: "シュート/キーパー",
            at: {
                label: "シュートAT",
                inputs: [
                    { id: "at-kick", label: "キック" },
                    { id: "at-ctrl", label: "コントロール" }
                ],
                formula: (v) => v['at-kick'] + v['at-ctrl']
            },
            df: {
                label: "キーパー(KP)", 
                inputs: [
                    { id: "df-press", label: "プレッシャー" },
                    { id: "df-phys", label: "フィジカル" },
                    { id: "df-agi", label: "アジリティ" }
                ],
                formula: (v) => (v['df-press']*2) + (v['df-phys']*3) + (v['df-agi']*4)
            },
            showWinRate: true
        },
        scramble: {
            name: "スクランブル",
            at: {
                label: "スクランブルAT",
                inputs: [
                    { id: "at-intel", label: "インテリジェンス" },
                    { id: "at-phys", label: "フィジカル" }
                ],
                formula: (v) => v['at-intel'] + v['at-phys']
            },
            df: {
                label: "スクランブルDF",
                inputs: [
                    { id: "df-intel", label: "インテリジェンス" },
                    { id: "df-press", label: "プレッシャー" }
                ],
                formula: (v) => v['df-intel'] + v['df-press']
            },
            showWinRate: true
        },
        direct: {
            name: "直接入力",
            at: { inputs: [], formula: null },
            df: { inputs: [], formula: null },
            showWinRate: true
        }
    };

    let currentMode = 'focus';

    function setMode(mode) {
        currentMode = mode;
        
        // Update Buttons
        document.querySelectorAll('.mode-selector .btn').forEach(b => {
            b.classList.remove('active');
            if (b.onclick.toString().includes(`setMode('${mode}')`)) {
                b.classList.add('active');
            }
        });

        // Render Inputs
        renderInputs('at', MODES[mode].at);
        renderInputs('df', MODES[mode].df);

        // Toggle Direct Input visibility
        const isDirect = mode === 'direct';
        document.getElementById('at-direct-input').classList.toggle('hidden', !isDirect);
        document.getElementById('df-direct-input').classList.toggle('hidden', !isDirect);
        
        // Toggle Tech Power Input visibility (Show only for non-direct modes)
        document.getElementById('at-tech-power-input').classList.toggle('hidden', isDirect);
        document.getElementById('df-tech-power-input').classList.toggle('hidden', isDirect);
        
        // Clear results
        document.getElementById('result-area').style.display = 'none';
        
        // Logic to clear/highlight tech buttons? Maybe keep previous selection
        // For now, just ensure tech power is updated based on current selections
        updateTechPower('at');
        updateTechPower('df');
    }

    function renderInputs(side, config) {
        const container = document.getElementById(`inputs-${side}-stats`);
        container.innerHTML = '';

        if (!config.inputs) return;

        config.inputs.forEach(input => {
            const div = document.createElement('div');
            div.className = 'input-group';
            div.innerHTML = `
                <label>${input.label}</label>
                <input type="number" id="${input.id}" class="stat-input" oninput="updatePreview('${side}')">
            `;
            container.appendChild(div);
        });
    }

    function getInputValue(id) {
        const el = document.getElementById(id);
        return el ? (parseFloat(el.value) || 0) : 0;
    }

    function applySpecialRounding(value) {
        const floor = Math.floor(value);
        const decimal = value - floor;
        if (decimal > 0.95) {
            return Math.ceil(value);
        }
        return Math.floor(value);
    }

    function calculateBasePower(side) {
        if (currentMode === 'direct') {
            return getInputValue(`${side}-real-value`);
        }
        
        const config = MODES[currentMode][side];
        if (!config || !config.formula) return 0;

        const values = {};
        config.inputs.forEach(i => {
            values[i.id] = getInputValue(i.id);
        });

        // Calculate Stat Base
        const rawStat = config.formula(values);
        const statBase = applySpecialRounding(rawStat);
        
        // Add Technique Power if applicable
        const techPower = getInputValue(`${side}-tech-power`);
        
        return statBase + techPower;
    }

    function updatePreview(side) {
        if (currentMode === 'direct') return;
        // Preview now shows (Stat + Tech) before passive
        const val = calculateBasePower(side);
        document.getElementById(`${side}-calc-preview`).textContent = val;
    }

    function calculateRD() {
        // 1. Get Base Values (Stat + Tech)
        const baseAt = calculateBasePower('at');
        const baseDf = calculateBasePower('df');

        // 2. Apply Passives
        // If input is empty/0, it treats as 0% boost (x1.0 total)
        const passiveAt = getInputValue('at-passive');
        const passiveDf = getInputValue('df-passive');

        // Formula: Total = Base * (1 + Passive%)
        const rawFinalAt = baseAt * ((100 + passiveAt) / 100);
        const rawFinalDf = baseDf * ((100 + passiveDf) / 100);
        
        // Apply Special Rounding to Final Values
        const finalAt = applySpecialRounding(rawFinalAt);
        const finalDf = applySpecialRounding(rawFinalDf);

        // 3. Calculate RD
        // Allow negative RD if DF > AT
        let rd = 0;
        if (finalAt + finalDf > 0) {
            rd = ((finalAt - finalDf) / (finalAt + finalDf)) * 100;
        }

        // Render Inputs
        // Show raw base and passive multiplier in parens
        document.getElementById('res-at-total').textContent = `${finalAt} (素点:${baseAt} x ${(100+passiveAt)/100})`;
        document.getElementById('res-df-total').textContent = `${finalDf} (素点:${baseDf} x ${(100+passiveDf)/100})`;
        document.getElementById('res-rd').textContent = rd.toFixed(2) + "%";

        // 4. Win Rate / Judgment Logic
        const resContainer = document.getElementById('win-rate-container');
        resContainer.innerHTML = ''; // Clear previous content

        // Determine Battle Logic based on Tech Usage
        // If EITHER side uses a move (Tech Power > 0), use Tech Battle Logic.
        // If BOTH sides use "No Tech" (Tech Power == 0), use Focus Battle Logic.
        
        const atTechBase = parseInt(document.getElementById('at-base-val').value) || 0;
        const dfTechBase = parseInt(document.getElementById('df-base-val').value) || 0;
        const isTechBattle = (atTechBase > 0 || dfTechBase > 0);

        if (!isTechBattle) {
            // === Focus Battle Logic (No Tech) ===
            // Formula: Rate = 30 + (20 * x) + (10 * RD)
            // x: 0 (Root), 0.5 (Center), 1 (Tip)
            
            function getBreakRate(rdVal, x) {
                const rate = 30 + (20 * x) + (10 * rdVal);
                return Math.max(0, Math.min(100, rate)); // Clamp 0-100
            }

            const rateRoot = getBreakRate(rd, 0.0);
            const rateCenter = getBreakRate(rd, 0.5);
            const rateTip = getBreakRate(rd, 1.0);

            // Helper to determine color
            function getRateStyle(rate) {
                if (rate >= 100) return "color: #dc2626;"; // Red (Win)
                if (rate <= 0) return "color: #2563eb;";   // Blue (Lose)
                return "color: #1f2937;"; // Default black/gray
            }

            const html = `
                <div style="margin-top:12px; border-top:1px solid #e5e7eb; padding-top:12px;">
                    <div style="font-weight:bold; margin-bottom:8px; text-align:center;">フォーカス判定予測 (技なし)</div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; font-size:0.95rem; max-width: 300px; margin: 0 auto;">
                        
                        <div style="text-align:right; color:#4b5563;">手の付け根</div> 
                        <div style="font-weight:bold; ${getRateStyle(rateRoot)}">${Math.round(rateRoot)}%</div>

                        <div style="text-align:right; color:#4b5563;">手の真ん中</div> 
                        <div style="font-weight:bold; ${getRateStyle(rateCenter)}">${Math.round(rateCenter)}%</div>

                        <div style="text-align:right; color:#4b5563;">指先</div> 
                        <div style="font-weight:bold; ${getRateStyle(rateTip)}">${Math.round(rateTip)}%</div>

                    </div>
                    <div style="font-size:0.8rem; color:#6b7280; margin-top:12px; text-align:center;">
                        ※RD+1%ごとに突破率+10%<br>
                        ※先端に行くほど突破率+20%
                    </div>
                </div>
            `;
            resContainer.innerHTML = html;
            
        } else {
            // === Tech Battle Logic (Step Function) ===
            // RD > +20: 100%
            // +10 < RD <= +20: 75%
            // -10 <= RD <= +10: 50%
            // -20 <= RD < -10: 25%
            // RD < -20: 0%

            let winRate = 0;
            let label = "";
            let labelColor = "";

            if (rd > 20) {
                winRate = 100;
                label = "勝利確定 (100%)";
                labelColor = "#dc2626"; // Red
            } else if (rd > 10) {
                winRate = 75;
                label = "有利 (75%)";
                labelColor = "#dc2626";
            } else if (rd >= -10) {
                winRate = 50;
                label = "互角 (50%)";
                labelColor = "#d97706"; // Orange/Yellow
            } else if (rd >= -20) {
                winRate = 25;
                label = "不利 (25%)";
                labelColor = "#2563eb"; // Blue
            } else {
                winRate = 0;
                label = "敗北確定 (0%)";
                labelColor = "#2563eb";
            }

            const html = `
                 <div class="win-rate">AT勝率: ${winRate}%</div>
                 <div style="text-align: center; margin-top: 8px; font-weight:bold; font-size:1.2rem; color: ${labelColor};">${label}</div>
                 <div style="font-size:0.8rem; color:#6b7280; margin-top:12px; text-align:center; border-top: 1px dashed #e5e7eb; padding-top: 8px;">
                    <div>技バトル判定</div>
                    <div style="margin-top:4px;">±10%以内: 50%</div>
                    <div>±20%以内: 75% / 25%</div>
                    <div>それ以上: 100% / 0%</div>
                 </div>
            `;
            resContainer.innerHTML = html;
        }

        document.getElementById('result-area').style.display = 'block';
    }

    // Initialize
    initTechButtons('at');
    initTechButtons('df');
    setMode('focus');
    </script>
  </body>
</html>
